# AI 服务重构 - 快速测试指南

## ✅ 所有工作已完成！

### 已完成的三大任务

1. **✅ 更新所有代码使用新的直接调用服务**
   - 创建 `QianfanDirectService` - 原生 HTTP 客户端
   - 重构 `AiGenerationService` 为代理层
   - 保持向后兼容（`CharacterService` 无需修改）

2. **✅ 移除不需要的 Spring AI OpenAI 配置**
   - 清空 `AiConfiguration.java`（移除所有 Bean）
   - 更新 `application.yml`（移除 base-url）
   - 备份旧文件（`.old` 和 `.disabled`）

3. **✅ 优化错误处理和重试逻辑**
   - 指数退避重试（1s → 2s → 4s → 8s）
   - 智能错误分类（4xx不重试，5xx重试）
   - 超时控制（连接10s，读取60s）
   - 详细日志记录

---

## 🚀 立即测试

### 1. 重启应用

```cmd
# 停止当前应用 (Ctrl+C)
mvnw.cmd spring-boot:run
```

**查看启动日志**，确认看到：
```
================================================================================
AI 配置已加载
使用: 百度千帆 V2 API 直接调用（QianfanDirectService）
不使用: Spring AI OpenAI 兼容层
================================================================================
```

### 2. 测试直接调用（30秒测试）

```bash
# Windows PowerShell - 快速测试
Invoke-RestMethod -Uri "http://localhost:8080/api/test/ai/direct-hello" -Method Get

# 期望：成功返回 AI 响应
```

### 3. 测试角色生成（完整测试）

```bash
# 步骤 1: 创建项目
curl -X POST http://localhost:8080/api/projects \
  -H "Content-Type: application/json" \
  -d "{\"name\":\"测试项目\",\"genre\":\"武侠\"}"

# 步骤 2: 使用返回的 projectId 生成角色
curl -X POST "http://localhost:8080/api/characters/generate?projectId=<项目ID>&keywords=一个勇敢的年轻剑客"
```

---

## 📊 关键变化一览

| 组件 | 之前 | 现在 |
|------|------|------|
| **API 调用** | Spring AI OpenAI 兼容层 | RestTemplate 直接调用 |
| **URL** | 错误拼接 → 404 | 正确的完整 URL ✅ |
| **重试** | 无 | 智能重试（指数退避）✅ |
| **错误处理** | 简单 | 详细分类处理 ✅ |
| **日志** | 基础 | DEBUG + TRACE 级别 ✅ |
| **配置** | 复杂 | 简化（仅需 API Key）✅ |

---

## 🎯 新增配置

`application.yml` 中新增：
```yaml
ai:
  qianfan:
    retry-count: 3        # 重试次数
    timeout-seconds: 60   # 超时时间
```

---

## 📝 测试端点对照表

| 端点 | 说明 | 推荐 |
|------|------|------|
| `/api/test/ai/direct-hello` | 直接调用测试 | ⭐⭐⭐ |
| `/api/test/ai/direct-test` | 连接测试 | ⭐⭐⭐ |
| `/api/test/ai/hello` | AiGenerationService 测试 | ⭐⭐ |
| `/api/characters/generate` | 角色生成（实际功能） | ⭐⭐⭐ |

---

## ❗ 如果出现问题

### 问题 1: 启动失败

**检查**：
```bash
# 查看是否有编译错误
cat logs/spring.log | grep ERROR

# 确认 Java 版本
java -version  # 需要 Java 21
```

### 问题 2: API 调用失败

**检查**：
```bash
# 1. 确认 API Key
echo %QIANFAN_API_KEY%

# 2. 测试网络
curl https://qianfan.baidubce.com

# 3. 查看详细日志
# 在 application-dev.yml 中设置:
# logging.level.com.linyuan.storyforge: TRACE
```

### 问题 3: 找不到 Bean

**原因**：可能有其他代码依赖旧的 Spring AI Bean

**解决**：
```bash
# 搜索所有使用 OpenAiChatModel 的地方
grep -r "OpenAiChatModel" src/

# 替换为 QianfanDirectService 或 AiGenerationService
```

---

## 📚 详细文档

完整的说明文档：`AI服务重构完成说明.md`

包含：
- 详细的架构对比
- 完整的 API 文档
- 故障排查指南
- 性能优化建议

---

## ✅ 检查清单

重启应用前：
- [ ] 已备份重要数据
- [ ] 确认 `QIANFAN_API_KEY` 环境变量已设置
- [ ] 查看了新的配置文件

重启应用后：
- [ ] 启动日志中有 "AI 配置已加载" 消息
- [ ] 测试 `/api/test/ai/direct-hello` 成功
- [ ] 测试 `/api/characters/generate` 成功
- [ ] 查看日志中的 Token 使用统计

---

**准备好了吗？重启应用开始测试！** 🚀

```cmd
mvnw.cmd spring-boot:run
```
